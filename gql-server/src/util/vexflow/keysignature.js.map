{"version":3,"sources":["../../../node_modules/vexflow/src/keysignature.js"],"names":["KeySignature","StaveModifier","CATEGORY","accidentalSpacing","above","below","constructor","keySpec","cancelKeySpec","alterKeySpec","setAttribute","setKeySig","setPosition","Position","BEGIN","glyphFontScale","glyphs","xPositions","paddingForced","getCategory","convertToGlyph","acc","nextAcc","accGlyphData","Flow","accidentalCodes","type","glyph","Glyph","code","extraWidth","spacing","isAbove","line","placeGlyphOnLine","stave","push","xPosition","length","glyphWidth","getMetrics","width","cancelKey","spec","formatted","convertToCancelAccList","cancel_accList","keySignature","different_types","accList","naturals","undefined","cancelled","i","index","concat","addToStave","addModifier","convertAccLines","clef","offset","customLines","getPadding","format","padding","getWidth","alterKey","convertToAlterAccList","max","Math","min","Vex","RERR","firstAccidentalType","cancelAccList","position","END","endClef","draw","x","setRendered","setStave","setContext","context","renderToStave"],"mappings":"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","sourcesContent":["// [VexFlow](http://vexflow.com) - Copyright (c) Mohit Muthanna 2010.\n// Author: Cyril Silverman\n//\n// ## Description\n//\n// This file implements key signatures. A key signature sits on a stave\n// and indicates the notes with implicit accidentals.\n\nimport { Vex } from './vex';\nimport { Flow } from './tables';\nimport { StaveModifier } from './stavemodifier';\nimport { Glyph } from './glyph';\n\nexport class KeySignature extends StaveModifier {\n  static get CATEGORY() { return 'keysignatures'; }\n\n  // Space between natural and following accidental depending\n  // on vertical position\n  static get accidentalSpacing() {\n    return {\n      '#': {\n        above: 6,\n        below: 4,\n      },\n      'b': {\n        above: 4,\n        below: 7,\n      },\n      'n': {\n        above: 4,\n        below: 1,\n      },\n      '##': {\n        above: 6,\n        below: 4,\n      },\n      'bb': {\n        above: 4,\n        below: 7,\n      },\n      'db': {\n        above: 4,\n        below: 7,\n      },\n      'd': {\n        above: 4,\n        below: 7,\n      },\n      'bbs': {\n        above: 4,\n        below: 7,\n      },\n      '++': {\n        above: 6,\n        below: 4,\n      },\n      '+': {\n        above: 6,\n        below: 4,\n      },\n      '+-': {\n        above: 6,\n        below: 4,\n      },\n      '++-': {\n        above: 6,\n        below: 4,\n      },\n      'bs': {\n        above: 4,\n        below: 10,\n      },\n      'bss': {\n        above: 4,\n        below: 10,\n      },\n    };\n  }\n\n  // Create a new Key Signature based on a `key_spec`\n  constructor(keySpec, cancelKeySpec, alterKeySpec) {\n    super();\n    this.setAttribute('type', 'KeySignature');\n\n    this.setKeySig(keySpec, cancelKeySpec, alterKeySpec);\n    this.setPosition(StaveModifier.Position.BEGIN);\n    this.glyphFontScale = 38; // TODO(0xFE): Should this match StaveNote?\n    this.glyphs = [];\n    this.xPositions = []; // relative to this.x\n    this.paddingForced = false;\n  }\n\n  getCategory() { return KeySignature.CATEGORY; }\n\n  // Add an accidental glyph to the `KeySignature` instance which represents\n  // the provided `acc`. If `nextAcc` is also provided, the appropriate\n  // spacing will be included in the glyph's position\n  convertToGlyph(acc, nextAcc) {\n    const accGlyphData = Flow.accidentalCodes(acc.type);\n    const glyph = new Glyph(accGlyphData.code, this.glyphFontScale);\n\n    // Determine spacing between current accidental and the next accidental\n    let extraWidth = 1;\n    if (acc.type === 'n' && nextAcc) {\n      const spacing = KeySignature.accidentalSpacing[nextAcc.type];\n      if (spacing) {\n        const isAbove = nextAcc.line >= acc.line;\n        extraWidth = isAbove ? spacing.above : spacing.below;\n      }\n    }\n\n    // Place the glyph on the stave\n    this.placeGlyphOnLine(glyph, this.stave, acc.line);\n    this.glyphs.push(glyph);\n\n    const xPosition = this.xPositions[this.xPositions.length - 1];\n    const glyphWidth = glyph.getMetrics().width + extraWidth;\n    // Store the next accidental's x position\n    this.xPositions.push(xPosition + glyphWidth);\n    // Expand size of key signature\n    this.width += glyphWidth;\n  }\n\n  // Cancel out a key signature provided in the `spec` parameter. This will\n  // place appropriate natural accidentals before the key signature.\n  cancelKey(spec) {\n    this.formatted = false;\n    this.cancelKeySpec = spec;\n\n    return this;\n  }\n\n  convertToCancelAccList(spec) {\n    // Get the accidental list for the cancelled key signature\n    const cancel_accList = Flow.keySignature(spec);\n\n    // If the cancelled key has a different accidental type, ie: # vs b\n    const different_types = this.accList.length > 0\n      && cancel_accList.length > 0\n      && cancel_accList[0].type !== this.accList[0].type;\n\n    // Determine how many naturals needed to add\n    const naturals = different_types\n      ? cancel_accList.length\n      : cancel_accList.length - this.accList.length;\n\n    // Return if no naturals needed\n    if (naturals < 1) return undefined;\n\n    // Get the line position for each natural\n    const cancelled = [];\n    for (let i = 0; i < naturals; i++) {\n      let index = i;\n      if (!different_types) {\n        index = cancel_accList.length - naturals + i;\n      }\n\n      const acc = cancel_accList[index];\n      cancelled.push({ type: 'n', line: acc.line });\n    }\n\n    // Combine naturals with main accidental list for the key signature\n    this.accList = cancelled.concat(this.accList);\n\n    return {\n      accList: cancelled,\n      type: cancel_accList[0].type\n    };\n  }\n\n  // Deprecated\n  addToStave(stave) {\n    this.paddingForced = true;\n    stave.addModifier(this);\n\n    return this;\n  }\n\n  // Apply the accidental staff line placement based on the `clef` and\n  // the  accidental `type` for the key signature ('# or 'b').\n  convertAccLines(clef, type, accList = this.accList) {\n    let offset = 0.0; // if clef === \"treble\"\n    let customLines; // when clef doesn't follow treble key sig shape\n\n    switch (clef) {\n      // Treble & Subbass both have offsets of 0, so are not included.\n      case 'soprano':\n        if (type === '#') customLines = [2.5, 0.5, 2, 0, 1.5, -0.5, 1];\n        else offset = -1;\n        break;\n      case 'mezzo-soprano':\n        if (type === 'b') customLines = [0, 2, 0.5, 2.5, 1, 3, 1.5];\n        else offset = 1.5;\n        break;\n      case 'alto':\n        offset = 0.5;\n        break;\n      case 'tenor':\n        if (type === '#') customLines = [3, 1, 2.5, 0.5, 2, 0, 1.5];\n        else offset = -0.5;\n        break;\n      case 'baritone-f':\n      case 'baritone-c':\n        if (type === 'b') customLines = [0.5, 2.5, 1, 3, 1.5, 3.5, 2];\n        else offset = 2;\n        break;\n      case 'bass':\n      case 'french':\n        offset = 1;\n        break;\n      default:\n        break;\n    }\n\n    // If there's a special case, assign those lines/spaces:\n    let i;\n    if (typeof customLines !== 'undefined') {\n      for (i = 0; i < accList.length; ++i) {\n        accList[i].line = customLines[i];\n      }\n    } else if (offset !== 0) {\n      for (i = 0; i < accList.length; ++i) {\n        accList[i].line += offset;\n      }\n    }\n  }\n\n  getPadding(index) {\n    if (!this.formatted) this.format();\n\n    return (\n      this.glyphs.length === 0 || (!this.paddingForced && index < 2) ?\n        0 : this.padding\n    );\n  }\n\n  getWidth() {\n    if (!this.formatted) this.format();\n\n    return this.width;\n  }\n\n  setKeySig(keySpec, cancelKeySpec, alterKeySpec) {\n    this.formatted = false;\n    this.keySpec = keySpec;\n    this.cancelKeySpec = cancelKeySpec;\n    this.alterKeySpec = alterKeySpec;\n\n    return this;\n  }\n\n  // Alter the accidentals of a key spec one by one.\n  // Each alteration is a new accidental that replaces the\n  // original accidental (or the canceled one).\n  alterKey(alterKeySpec) {\n    this.formatted = false;\n    this.alterKeySpec = alterKeySpec;\n\n    return this;\n  }\n\n  convertToAlterAccList(alterKeySpec) {\n    const max = Math.min(alterKeySpec.length, this.accList.length);\n    for (let i = 0; i < max; ++i) {\n      if (alterKeySpec[i]) {\n        this.accList[i].type = alterKeySpec[i];\n      }\n    }\n  }\n\n  format() {\n    if (!this.stave) {\n      throw new Vex.RERR('KeySignatureError', \"Can't draw key signature without stave.\");\n    }\n\n    this.width = 0;\n    this.glyphs = [];\n    this.xPositions = [0]; // initialize with initial x position\n    this.accList = Flow.keySignature(this.keySpec);\n    const accList = this.accList;\n    const firstAccidentalType = accList.length > 0 ? accList[0].type : null;\n    let cancelAccList;\n    if (this.cancelKeySpec) {\n      cancelAccList = this.convertToCancelAccList(this.cancelKeySpec);\n    }\n    if (this.alterKeySpec) {\n      this.convertToAlterAccList(this.alterKeySpec);\n    }\n\n    if (this.accList.length > 0) {\n      const clef = ((this.position === StaveModifier.Position.END) ?\n        this.stave.endClef : this.stave.clef) || this.stave.clef;\n      if (cancelAccList) {\n        this.convertAccLines(clef, cancelAccList.type, cancelAccList.accList);\n      }\n      this.convertAccLines(clef, firstAccidentalType, accList);\n      for (let i = 0; i < this.accList.length; ++i) {\n        this.convertToGlyph(this.accList[i], this.accList[i + 1]);\n      }\n    }\n\n    this.formatted = true;\n  }\n\n  draw() {\n    if (!this.x) {\n      throw new Vex.RERR('KeySignatureError', \"Can't draw key signature without x.\");\n    }\n\n    if (!this.stave) {\n      throw new Vex.RERR('KeySignatureError', \"Can't draw key signature without stave.\");\n    }\n\n    if (!this.formatted) this.format();\n    this.setRendered();\n\n    for (let i = 0; i < this.glyphs.length; i++) {\n      const glyph = this.glyphs[i];\n      const x = this.x + this.xPositions[i];\n      glyph.setStave(this.stave);\n      glyph.setContext(this.stave.context);\n      glyph.renderToStave(x);\n    }\n  }\n}\n"],"file":"keysignature.js"}