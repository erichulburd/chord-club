{"version":3,"sources":["../../../node_modules/vexflow/src/stavenote.js"],"names":["L","args","StaveNote","DEBUG","Vex","getStemAdjustment","note","Stem","WIDTH","getStemDirection","isInnerNoteIndex","index","UP","keyProps","length","shiftRestVertical","rest","dir","delta","isrest","line","maxLine","minLine","setKeyLine","getKeyLine","centerRest","noteU","noteL","MidLine","StemmableNote","CATEGORY","STEM_UP","STEM_DOWN","DOWN","DEFAULT_LEDGER_LINE_OFFSET","format","notes","state","getStave","formatByY","notesList","i","props","getKeyProps","minL","stemDirection","stemMax","getStemLength","stemMin","getStemMinumumLength","maxL","isRest","glyph","line_above","line_below","push","voice_shift","getVoiceShiftWidth","is_displaced","isDisplaced","voices","noteM","voiceXShift","Math","max","xShift","stemDelta","lineSpacing","abs","setStemLength","setXShift","restHeight","space","hasStave","RERR","topNote","bottomNote","topKeys","bottomKeys","HALF_NOTEHEAD_HEIGHT","topNoteBottomY","getYForLine","bottomNoteTopY","areNotesColliding","right_shift","postFormat","forEach","constructor","noteStruct","setAttribute","keys","clef","octave_shift","beam","Flow","getGlyphProps","duration","noteType","RuntimeError","JSON","stringify","displaced","dot_shiftY","use_default_head_x","note_heads","modifiers","Merge","render_options","glyph_font_scale","DEFAULT_NOTATION_FONT_SCALE","stroke_px","calculateKeyProps","buildStem","auto_stem","autoStem","setStemDirection","stem_direction","reset","buildFlag","noteHeadStyles","map","noteHead","getStyle","buildNoteHeads","setStyle","stave","head","setStave","calcNoteDisplacements","setBeam","getCategory","setStem","hide","getKeys","lastLine","lineDiff","start","end","step","noteProps","notehead","NoteHead","note_type","custom_glyph_code","code","x_shift","shift_right","stem_up_x_offset","stem_down_x_offset","MIDDLE_LINE","decider","key","position","options","keyProperties","Infinity","W","sort","a","b","getBoundingBox","preFormatted","width","w","modLeftPx","leftDisplacedHeadPx","getMetrics","x","getAbsoluteX","minY","maxY","halfLineSpacing","getSpacingBetweenLines","y","ys","frac","durationToFraction","equals","stem","getStemExtents","baseY","min","topY","yy","BoundingBox","getLineNumber","isTopNote","resultLine","thisLine","isChord","hasStem","hasFlag","getStemX","getCenterGlyphX","getYForTopText","textLine","extents","annotation_spacing","getYForBottomText","getY","setYs","y_top","y_bottom","getNoteHeadBounds","setYBounds","setNoteDisplaced","getTieRightX","tieStartX","getGlyphWidth","rightDisplacedHeadPx","modifierContext","getRightShift","getTieLeftX","tieEndX","getLineForRest","restLine","top","bot","getModifierStartXY","ABOVE","BELOW","LEFT","RIGHT","Modifier","Position","forceFlagRight","flag","style","setStemStyle","getStem","getStemStyle","setLedgerLineStyle","ledgerLineStyle","getLedgerLineStyle","setFlagStyle","flagStyle","getFlagStyle","setKeyStyle","addToModifierContext","mContext","setModifierContext","addModifier","setPreFormatted","modifier","setNote","setIndex","addAccidental","accidental","addArticulation","articulation","addAnnotation","annotation","addDot","dot","Dot","setDotShiftY","dots","addDotToAll","getAccidentals","getModifiers","getDots","setLeftDisplacedHeadPx","setRightDisplacedHeadPx","preFormat","setWidth","yTop","yBottom","nonDisplacedX","displacedX","highestLine","getNumLines","lowestLine","highestDisplacedLine","lowestDisplacedLine","highestNonDisplacedLine","lowestNonDisplacedLine","getLine","displaced_x","non_displaced_x","highest_line","lowest_line","highest_displaced_line","lowest_displaced_line","highest_non_displaced_line","lowest_non_displaced_line","getNoteHeadBeginX","getNoteHeadEndX","xBegin","drawLedgerLines","context","ctx","getWidth","doubleWidth","min_x","drawLedgerLine","normal","ledgerWidth","beginPath","moveTo","lineTo","stroke","applyStyle","getYForNote","restoreStyle","drawModifiers","openGroup","getIndex","noteheadStyle","setContext","drawWithStyle","closeGroup","drawFlag","shouldRenderFlag","getGlyph","noteStemHeight","getHeight","flagX","flagY","pointerBBox","render","drawNoteHeads","draw","drawStem","stemStruct","shouldRenderStem","setX","stemX","setNoteHeadXBounds","getAttribute","setRendered"],"mappings":"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","sourcesContent":["// [VexFlow](http://vexflow.com) - Copyright (c) Mohit Muthanna 2010.\n//\n// ## Description\n// This file implements notes for standard notation. This consists of one or\n// more `NoteHeads`, an optional stem, and an optional flag.\n//\n// *Throughout these comments, a \"note\" refers to the entire `StaveNote`,\n// and a \"key\" refers to a specific pitch/notehead within a note.*\n//\n// See `tests/stavenote_tests.js` for usage examples.\n\nimport { Vex } from './vex';\nimport { Flow } from './tables';\nimport { BoundingBox } from './boundingbox';\nimport { Stem } from './stem';\nimport { NoteHead } from './notehead';\nimport { StemmableNote } from './stemmablenote';\nimport { Modifier } from './modifier';\nimport { Dot } from './dot';\n\n// To enable logging for this class. Set `Vex.Flow.StaveNote.DEBUG` to `true`.\nfunction L(...args) { if (StaveNote.DEBUG) Vex.L('Vex.Flow.StaveNote', args); }\n\nconst getStemAdjustment = (note) => Stem.WIDTH / (2 * -note.getStemDirection());\n\nconst isInnerNoteIndex = (note, index) =>\n  index === (note.getStemDirection() === Stem.UP ? note.keyProps.length - 1 : 0);\n\n// Helper methods for rest positioning in ModifierContext.\nfunction shiftRestVertical(rest, note, dir) {\n  const delta = (note.isrest ? 0.0 : 1.0) * dir;\n\n  rest.line += delta;\n  rest.maxLine += delta;\n  rest.minLine += delta;\n  rest.note.setKeyLine(0, rest.note.getKeyLine(0) + (delta));\n}\n\n// Called from formatNotes :: center a rest between two notes\nfunction centerRest(rest, noteU, noteL) {\n  const delta = rest.line - Vex.MidLine(noteU.minLine, noteL.maxLine);\n  rest.note.setKeyLine(0, rest.note.getKeyLine(0) - delta);\n  rest.line -= delta;\n  rest.maxLine -= delta;\n  rest.minLine -= delta;\n}\n\nexport class StaveNote extends StemmableNote {\n  static get CATEGORY() { return 'stavenotes'; }\n  static get STEM_UP() { return Stem.UP; }\n  static get STEM_DOWN() { return Stem.DOWN; }\n  static get DEFAULT_LEDGER_LINE_OFFSET() { return 3; }\n\n  // ## Static Methods\n  //\n  // Format notes inside a ModifierContext.\n  static format(notes, state) {\n    if (!notes || notes.length < 2) return false;\n\n    // FIXME: VexFlow will soon require that a stave be set before formatting.\n    // Which, according to the below condition, means that following branch will\n    // always be taken and the rest of this function is dead code.\n    //\n    // Problematically, `Formatter#formatByY` was not designed to work for more\n    // than 2 voices (although, doesn't throw on this condition, just tries\n    // to power through).\n    //\n    // Based on the above:\n    //   * 2 voices can be formatted *with or without* a stave being set but\n    //     the output will be different\n    //   * 3 voices can only be formatted *without* a stave\n    if (notes[0].getStave()) {\n      return StaveNote.formatByY(notes, state);\n    }\n\n    const notesList = [];\n\n    for (let i = 0; i < notes.length; i++) {\n      const props = notes[i].getKeyProps();\n      const line = props[0].line;\n      let minL = props[props.length - 1].line;\n      const stemDirection = notes[i].getStemDirection();\n      const stemMax = notes[i].getStemLength() / 10;\n      const stemMin = notes[i].getStemMinumumLength() / 10;\n\n      let maxL;\n      if (notes[i].isRest()) {\n        maxL = line + notes[i].glyph.line_above;\n        minL = line - notes[i].glyph.line_below;\n      } else {\n        maxL = stemDirection === 1\n          ? props[props.length - 1].line + stemMax\n          : props[props.length - 1].line;\n\n        minL = stemDirection === 1\n          ? props[0].line\n          : props[0].line - stemMax;\n      }\n\n      notesList.push({\n        line: props[0].line, // note/rest base line\n        maxLine: maxL, // note/rest upper bounds line\n        minLine: minL, // note/rest lower bounds line\n        isrest: notes[i].isRest(),\n        stemDirection,\n        stemMax, // Maximum (default) note stem length;\n        stemMin, // minimum note stem length\n        voice_shift: notes[i].getVoiceShiftWidth(),\n        is_displaced: notes[i].isDisplaced(), // note manually displaced\n        note: notes[i],\n      });\n    }\n\n    const voices = notesList.length;\n\n    let noteU = notesList[0];\n    const noteM = voices > 2 ? notesList[1] : null;\n    let noteL = voices > 2 ? notesList[2] : notesList[1];\n\n    // for two voice backward compatibility, ensure upper voice is stems up\n    // for three voices, the voices must be in order (upper, middle, lower)\n    if (voices === 2 && noteU.stemDirection === -1 && noteL.stemDirection === 1) {\n      noteU = notesList[1];\n      noteL = notesList[0];\n    }\n\n    const voiceXShift = Math.max(noteU.voice_shift, noteL.voice_shift);\n    let xShift = 0;\n    let stemDelta;\n\n    // Test for two voice note intersection\n    if (voices === 2) {\n      const lineSpacing = noteU.stemDirection === noteL.stemDirection ? 0.0 : 0.5;\n      // if top voice is a middle voice, check stem intersection with lower voice\n      if (noteU.stemDirection === noteL.stemDirection &&\n        noteU.minLine <= noteL.maxLine) {\n        if (!noteU.isrest) {\n          stemDelta = Math.abs(noteU.line - (noteL.maxLine + 0.5));\n          stemDelta = Math.max(stemDelta, noteU.stemMin);\n          noteU.minLine = noteU.line - stemDelta;\n          noteU.note.setStemLength(stemDelta * 10);\n        }\n      }\n      if (noteU.minLine <= noteL.maxLine + lineSpacing) {\n        if (noteU.isrest) {\n          // shift rest up\n          shiftRestVertical(noteU, noteL, 1);\n        } else if (noteL.isrest) {\n          // shift rest down\n          shiftRestVertical(noteL, noteU, -1);\n        } else {\n          xShift = voiceXShift;\n          if (noteU.stemDirection === noteL.stemDirection) {\n            // upper voice is middle voice, so shift it right\n            noteU.note.setXShift(xShift + 3);\n          } else {\n            // shift lower voice right\n            noteL.note.setXShift(xShift);\n          }\n        }\n      }\n\n      // format complete\n      return true;\n    }\n\n    // Check middle voice stem intersection with lower voice\n    if (noteM !== null && noteM.minLine < noteL.maxLine + 0.5) {\n      if (!noteM.isrest) {\n        stemDelta = Math.abs(noteM.line - (noteL.maxLine + 0.5));\n        stemDelta = Math.max(stemDelta, noteM.stemMin);\n        noteM.minLine = noteM.line - stemDelta;\n        noteM.note.setStemLength(stemDelta * 10);\n      }\n    }\n\n    // For three voices, test if rests can be repositioned\n    //\n    // Special case 1 :: middle voice rest between two notes\n    //\n    if (noteM.isrest && !noteU.isrest && !noteL.isrest) {\n      if (noteU.minLine <= noteM.maxLine || noteM.minLine <= noteL.maxLine) {\n        const restHeight = noteM.maxLine - noteM.minLine;\n        const space = noteU.minLine - noteL.maxLine;\n        if (restHeight < space) {\n          // center middle voice rest between the upper and lower voices\n          centerRest(noteM, noteU, noteL);\n        } else {\n          xShift = voiceXShift + 3;    // shift middle rest right\n          noteM.note.setXShift(xShift);\n        }\n        // format complete\n        return true;\n      }\n    }\n\n    // Special case 2 :: all voices are rests\n    if (noteU.isrest && noteM.isrest && noteL.isrest) {\n      // Shift upper voice rest up\n      shiftRestVertical(noteU, noteM, 1);\n      // Shift lower voice rest down\n      shiftRestVertical(noteL, noteM, -1);\n      // format complete\n      return true;\n    }\n\n    // Test if any other rests can be repositioned\n    if (noteM.isrest && noteU.isrest && noteM.minLine <= noteL.maxLine) {\n      // Shift middle voice rest up\n      shiftRestVertical(noteM, noteL, 1);\n    }\n    if (noteM.isrest && noteL.isrest && noteU.minLine <= noteM.maxLine) {\n      // Shift middle voice rest down\n      shiftRestVertical(noteM, noteU, -1);\n    }\n    if (noteU.isrest && noteU.minLine <= noteM.maxLine) {\n      // shift upper voice rest up;\n      shiftRestVertical(noteU, noteM, 1);\n    }\n    if (noteL.isrest && noteM.minLine <= noteL.maxLine) {\n      // shift lower voice rest down\n      shiftRestVertical(noteL, noteM, -1);\n    }\n\n    // If middle voice intersects upper or lower voice\n    if ((!noteU.isrest && !noteM.isrest && noteU.minLine <= noteM.maxLine + 0.5) ||\n      (!noteM.isrest && !noteL.isrest && noteM.minLine <= noteL.maxLine)) {\n      xShift = voiceXShift + 3;      // shift middle note right\n      noteM.note.setXShift(xShift);\n    }\n\n    return true;\n  }\n\n  static formatByY(notes, state) {\n    // NOTE: this function does not support more than two voices per stave\n    // use with care.\n    let hasStave = true;\n\n    for (let i = 0; i < notes.length; i++) {\n      hasStave = hasStave && notes[i].getStave() != null;\n    }\n\n    if (!hasStave) {\n      throw new Vex.RERR(\n        'Stave Missing',\n        'All notes must have a stave - Vex.Flow.ModifierContext.formatMultiVoice!'\n      );\n    }\n\n    let xShift = 0;\n\n    for (let i = 0; i < notes.length - 1; i++) {\n      let topNote = notes[i];\n      let bottomNote = notes[i + 1];\n\n      if (topNote.getStemDirection() === Stem.DOWN) {\n        topNote = notes[i + 1];\n        bottomNote = notes[i];\n      }\n\n      const topKeys = topNote.getKeyProps();\n      const bottomKeys = bottomNote.getKeyProps();\n\n      const HALF_NOTEHEAD_HEIGHT = 0.5;\n\n      // `keyProps` and `stave.getYForLine` have different notions of a `line`\n      // so we have to convert the keyProps value by subtracting 5.\n      // See https://github.com/0xfe/vexflow/wiki/Development-Gotchas\n      //\n      // We also extend the y for each note by a half notehead because the\n      // notehead's origin is centered\n      const topNoteBottomY = topNote\n        .getStave()\n        .getYForLine(5 - topKeys[0].line + HALF_NOTEHEAD_HEIGHT);\n\n      const bottomNoteTopY = bottomNote\n        .getStave()\n        .getYForLine(5 - bottomKeys[bottomKeys.length - 1].line - HALF_NOTEHEAD_HEIGHT);\n\n      const areNotesColliding = bottomNoteTopY - topNoteBottomY < 0;\n\n      if (areNotesColliding) {\n        xShift = topNote.getVoiceShiftWidth() + 2;\n        bottomNote.setXShift(xShift);\n      }\n    }\n\n    state.right_shift += xShift;\n  }\n\n  static postFormat(notes) {\n    if (!notes) return false;\n\n    notes.forEach(note => note.postFormat());\n\n    return true;\n  }\n\n  constructor(noteStruct) {\n    super(noteStruct);\n    this.setAttribute('type', 'StaveNote');\n\n    this.keys = noteStruct.keys;\n    this.clef = noteStruct.clef;\n    this.octave_shift = noteStruct.octave_shift;\n    this.beam = null;\n\n    // Pull note rendering properties\n    this.glyph = Flow.getGlyphProps(this.duration, this.noteType);\n\n    if (!this.glyph) {\n      throw new Vex.RuntimeError(\n        'BadArguments',\n        `Invalid note initialization data (No glyph found): ${JSON.stringify(noteStruct)}`\n      );\n    }\n\n    // if true, displace note to right\n    this.displaced = false;\n    this.dot_shiftY = 0;\n    // per-pitch properties\n    this.keyProps = [];\n    // for displaced ledger lines\n    this.use_default_head_x = false;\n\n    // Drawing\n    this.note_heads = [];\n    this.modifiers = [];\n\n    Vex.Merge(this.render_options, {\n      // font size for note heads and rests\n      glyph_font_scale: noteStruct.glyph_font_scale || Flow.DEFAULT_NOTATION_FONT_SCALE,\n      // number of stroke px to the left and right of head\n      stroke_px: noteStruct.stroke_px || StaveNote.DEFAULT_LEDGER_LINE_OFFSET,\n    });\n\n    this.calculateKeyProps();\n    this.buildStem();\n\n    // Set the stem direction\n    if (noteStruct.auto_stem) {\n      this.autoStem();\n    } else {\n      this.setStemDirection(noteStruct.stem_direction);\n    }\n    this.reset();\n    this.buildFlag();\n  }\n\n  reset() {\n    super.reset();\n\n    // Save prior noteHead styles & reapply them after making new noteheads.\n    const noteHeadStyles = this.note_heads.map(noteHead => noteHead.getStyle());\n    this.buildNoteHeads();\n    this.note_heads.forEach((noteHead, index) => noteHead.setStyle(noteHeadStyles[index]));\n\n    if (this.stave) {\n      this.note_heads.forEach(head => head.setStave(this.stave));\n    }\n    this.calcNoteDisplacements();\n  }\n\n  setBeam(beam) {\n    this.beam = beam;\n    this.calcNoteDisplacements();\n    return this;\n  }\n\n  getCategory() { return StaveNote.CATEGORY; }\n\n  // Builds a `Stem` for the note\n  buildStem() {\n    this.setStem(new Stem({ hide: !!this.isRest(), }));\n  }\n\n  // Builds a `NoteHead` for each key in the note\n  buildNoteHeads() {\n    this.note_heads = [];\n    const stemDirection = this.getStemDirection();\n    const keys = this.getKeys();\n\n    let lastLine = null;\n    let lineDiff = null;\n    let displaced = false;\n\n    // Draw notes from bottom to top.\n\n    // For down-stem notes, we draw from top to bottom.\n    let start;\n    let end;\n    let step;\n    if (stemDirection === Stem.UP) {\n      start = 0;\n      end = keys.length;\n      step = 1;\n    } else if (stemDirection === Stem.DOWN) {\n      start = keys.length - 1;\n      end = -1;\n      step = -1;\n    }\n\n    for (let i = start; i !== end; i += step) {\n      const noteProps = this.keyProps[i];\n      const line = noteProps.line;\n\n      // Keep track of last line with a note head, so that consecutive heads\n      // are correctly displaced.\n      if (lastLine === null) {\n        lastLine = line;\n      } else {\n        lineDiff = Math.abs(lastLine - line);\n        if (lineDiff === 0 || lineDiff === 0.5) {\n          displaced = !displaced;\n        } else {\n          displaced = false;\n          this.use_default_head_x = true;\n        }\n      }\n      lastLine = line;\n\n      const notehead = new NoteHead({\n        duration: this.duration,\n        note_type: this.noteType,\n        displaced,\n        stem_direction: stemDirection,\n        custom_glyph_code: noteProps.code,\n        glyph_font_scale: this.render_options.glyph_font_scale,\n        x_shift: noteProps.shift_right,\n        stem_up_x_offset: noteProps.stem_up_x_offset,\n        stem_down_x_offset: noteProps.stem_down_x_offset,\n        line: noteProps.line,\n      });\n\n      this.note_heads[i] = notehead;\n    }\n  }\n\n  // Automatically sets the stem direction based on the keys in the note\n  autoStem() {\n    // Figure out optimal stem direction based on given notes\n    this.minLine = this.keyProps[0].line;\n    this.maxLine = this.keyProps[this.keyProps.length - 1].line;\n\n    const MIDDLE_LINE = 3;\n    const decider = (this.minLine + this.maxLine) / 2;\n    const stemDirection = decider < MIDDLE_LINE ? Stem.UP : Stem.DOWN;\n\n    this.setStemDirection(stemDirection);\n  }\n\n  // Calculates and stores the properties for each key in the note\n  calculateKeyProps() {\n    let lastLine = null;\n    for (let i = 0; i < this.keys.length; ++i) {\n      const key = this.keys[i];\n\n      // All rests use the same position on the line.\n      // if (this.glyph.rest) key = this.glyph.position;\n      if (this.glyph.rest) this.glyph.position = key;\n\n      const options = { octave_shift: this.octave_shift || 0 };\n      const props = Flow.keyProperties(key, this.clef, options);\n\n      if (!props) {\n        throw new Vex.RuntimeError('BadArguments', `Invalid key for note properties: ${key}`);\n      }\n\n      // Override line placement for default rests\n      if (props.key === 'R') {\n        if (this.duration === '1' || this.duration === 'w') {\n          props.line = 4;\n        } else {\n          props.line = 3;\n        }\n      }\n\n      // Calculate displacement of this note\n      const line = props.line;\n      if (lastLine === null) {\n        lastLine = line;\n      } else {\n        if (Math.abs(lastLine - line) === 0.5) {\n          this.displaced = true;\n          props.displaced = true;\n\n          // Have to mark the previous note as\n          // displaced as well, for modifier placement\n          if (this.keyProps.length > 0) {\n            this.keyProps[i - 1].displaced = true;\n          }\n        }\n      }\n\n      lastLine = line;\n      this.keyProps.push(props);\n    }\n\n    // Sort the notes from lowest line to highest line\n    lastLine = -Infinity;\n    this.keyProps.forEach(key => {\n      if (key.line < lastLine) {\n        Vex.W(\n          'Unsorted keys in note will be sorted. ' +\n          'See https://github.com/0xfe/vexflow/issues/104 for details.'\n        );\n      }\n      lastLine = key.line;\n    });\n    this.keyProps.sort((a, b) => a.line - b.line);\n  }\n\n  // Get the `BoundingBox` for the entire note\n  getBoundingBox() {\n    if (!this.preFormatted) {\n      throw new Vex.RERR('UnformattedNote', \"Can't call getBoundingBox on an unformatted note.\");\n    }\n\n    const { width: w, modLeftPx, leftDisplacedHeadPx } = this.getMetrics();\n    const x = this.getAbsoluteX() - modLeftPx - leftDisplacedHeadPx;\n\n    let minY = 0;\n    let maxY = 0;\n    const halfLineSpacing = this.getStave().getSpacingBetweenLines() / 2;\n    const lineSpacing = halfLineSpacing * 2;\n\n    if (this.isRest()) {\n      const y = this.ys[0];\n      const frac = Flow.durationToFraction(this.duration);\n      if (frac.equals(1) || frac.equals(2)) {\n        minY = y - halfLineSpacing;\n        maxY = y + halfLineSpacing;\n      } else {\n        minY = y - (this.glyph.line_above * lineSpacing);\n        maxY = y + (this.glyph.line_below * lineSpacing);\n      }\n    } else if (this.glyph.stem) {\n      const ys = this.getStemExtents();\n      ys.baseY += halfLineSpacing * this.stem_direction;\n      minY = Math.min(ys.topY, ys.baseY);\n      maxY = Math.max(ys.topY, ys.baseY);\n    } else {\n      minY = null;\n      maxY = null;\n\n      for (let i = 0; i < this.ys.length; ++i) {\n        const yy = this.ys[i];\n        if (i === 0) {\n          minY = yy;\n          maxY = yy;\n        } else {\n          minY = Math.min(yy, minY);\n          maxY = Math.max(yy, maxY);\n        }\n      }\n      minY -= halfLineSpacing;\n      maxY += halfLineSpacing;\n    }\n\n    return new BoundingBox(x, minY, w, maxY - minY);\n  }\n\n  // Gets the line number of the top or bottom note in the chord.\n  // If `isTopNote` is `true` then get the top note\n  getLineNumber(isTopNote) {\n    if (!this.keyProps.length) {\n      throw new Vex.RERR(\n        'NoKeyProps', \"Can't get bottom note line, because note is not initialized properly.\"\n      );\n    }\n\n    let resultLine = this.keyProps[0].line;\n\n    // No precondition assumed for sortedness of keyProps array\n    for (let i = 0; i < this.keyProps.length; i++) {\n      const thisLine = this.keyProps[i].line;\n      if (isTopNote) {\n        if (thisLine > resultLine) resultLine = thisLine;\n      } else {\n        if (thisLine < resultLine) resultLine = thisLine;\n      }\n    }\n\n    return resultLine;\n  }\n\n  // Determine if current note is a rest\n  isRest() { return this.glyph.rest; }\n\n  // Determine if the current note is a chord\n  isChord() { return !this.isRest() && this.keys.length > 1; }\n\n  // Determine if the `StaveNote` has a stem\n  hasStem() { return this.glyph.stem; }\n\n  hasFlag() {\n    return super.hasFlag() && !this.isRest();\n  }\n\n  getStemX() {\n    if (this.noteType === 'r') {\n      return this.getCenterGlyphX();\n    } else {\n      // We adjust the origin of the stem because we want the stem left-aligned\n      // with the notehead if stemmed-down, and right-aligned if stemmed-up\n      return super.getStemX() + getStemAdjustment(this);\n    }\n  }\n\n  // Get the `y` coordinate for text placed on the top/bottom of a\n  // note at a desired `text_line`\n  getYForTopText(textLine) {\n    const extents = this.getStemExtents();\n    return Math.min(\n      this.stave.getYForTopText(textLine),\n      extents.topY - (this.render_options.annotation_spacing * (textLine + 1))\n    );\n  }\n  getYForBottomText(textLine) {\n    const extents = this.getStemExtents();\n    return Math.max(\n      this.stave.getYForTopText(textLine),\n      extents.baseY + (this.render_options.annotation_spacing * (textLine))\n    );\n  }\n\n  // Sets the current note to the provided `stave`. This applies\n  // `y` values to the `NoteHeads`.\n  setStave(stave) {\n    super.setStave(stave);\n\n    const ys = this.note_heads.map(notehead => {\n      notehead.setStave(stave);\n      return notehead.getY();\n    });\n\n    this.setYs(ys);\n\n    if (this.stem) {\n      const { y_top, y_bottom } = this.getNoteHeadBounds();\n      this.stem.setYBounds(y_top, y_bottom);\n    }\n\n    return this;\n  }\n\n  // Get the pitches in the note\n  getKeys() { return this.keys; }\n\n  // Get the properties for all the keys in the note\n  getKeyProps() {\n    return this.keyProps;\n  }\n\n  // Check if note is shifted to the right\n  isDisplaced() {\n    return this.displaced;\n  }\n\n  // Sets whether shift note to the right. `displaced` is a `boolean`\n  setNoteDisplaced(displaced) {\n    this.displaced = displaced;\n    return this;\n  }\n\n  // Get the starting `x` coordinate for a `StaveTie`\n  getTieRightX() {\n    let tieStartX = this.getAbsoluteX();\n    tieStartX += this.getGlyphWidth() + this.x_shift + this.rightDisplacedHeadPx;\n    if (this.modifierContext) tieStartX += this.modifierContext.getRightShift();\n    return tieStartX;\n  }\n\n  // Get the ending `x` coordinate for a `StaveTie`\n  getTieLeftX() {\n    let tieEndX = this.getAbsoluteX();\n    tieEndX += this.x_shift - this.leftDisplacedHeadPx;\n    return tieEndX;\n  }\n\n  // Get the stave line on which to place a rest\n  getLineForRest() {\n    let restLine = this.keyProps[0].line;\n    if (this.keyProps.length > 1) {\n      const lastLine = this.keyProps[this.keyProps.length - 1].line;\n      const top = Math.max(restLine, lastLine);\n      const bot = Math.min(restLine, lastLine);\n      restLine = Vex.MidLine(top, bot);\n    }\n\n    return restLine;\n  }\n\n  // Get the default `x` and `y` coordinates for the provided `position`\n  // and key `index`\n  getModifierStartXY(position, index, options) {\n    options = options || {};\n    if (!this.preFormatted) {\n      throw new Vex.RERR('UnformattedNote', \"Can't call GetModifierStartXY on an unformatted note\");\n    }\n\n    if (this.ys.length === 0) {\n      throw new Vex.RERR('NoYValues', 'No Y-Values calculated for this note.');\n    }\n\n    const { ABOVE, BELOW, LEFT, RIGHT } = Modifier.Position;\n    let x = 0;\n    if (position === LEFT) {\n      // FIXME: Left modifier padding, move to font file\n      x = -1 * 2;\n    } else if (position === RIGHT) {\n      // FIXME: Right modifier padding, move to font file\n      x = this.getGlyphWidth() + this.x_shift + 2;\n\n      if (this.stem_direction === Stem.UP && this.hasFlag() &&\n        (options.forceFlagRight || isInnerNoteIndex(this, index))) {\n        x += this.flag.getMetrics().width;\n      }\n    } else if (position === BELOW || position === ABOVE) {\n      x = this.getGlyphWidth() / 2;\n    }\n\n    return {\n      x: this.getAbsoluteX() + x,\n      y: this.ys[index],\n    };\n  }\n\n  // Sets the style of the complete StaveNote, including all keys\n  // and the stem.\n  setStyle(style) {\n    super.setStyle(style);\n    this.note_heads.forEach(notehead => notehead.setStyle(style));\n    this.stem.setStyle(style);\n  }\n\n  setStemStyle(style) {\n    const stem = this.getStem();\n    stem.setStyle(style);\n  }\n  getStemStyle() { return this.stem.getStyle(); }\n\n  setLedgerLineStyle(style) { this.ledgerLineStyle = style; }\n  getLedgerLineStyle() { return this.ledgerLineStyle; }\n\n  setFlagStyle(style) { this.flagStyle = style; }\n  getFlagStyle() { return this.flagStyle; }\n\n  // Sets the notehead at `index` to the provided coloring `style`.\n  //\n  // `style` is an `object` with the following properties: `shadowColor`,\n  // `shadowBlur`, `fillStyle`, `strokeStyle`\n  setKeyStyle(index, style) {\n    this.note_heads[index].setStyle(style);\n    return this;\n  }\n\n  setKeyLine(index, line) {\n    this.keyProps[index].line = line;\n    this.reset();\n    return this;\n  }\n\n  getKeyLine(index) {\n    return this.keyProps[index].line;\n  }\n\n  // Add self to modifier context. `mContext` is the `ModifierContext`\n  // to be added to.\n  addToModifierContext(mContext) {\n    this.setModifierContext(mContext);\n    for (let i = 0; i < this.modifiers.length; ++i) {\n      this.modifierContext.addModifier(this.modifiers[i]);\n    }\n    this.modifierContext.addModifier(this);\n    this.setPreFormatted(false);\n    return this;\n  }\n\n  // Generic function to add modifiers to a note\n  //\n  // Parameters:\n  // * `index`: The index of the key that we're modifying\n  // * `modifier`: The modifier to add\n  addModifier(index, modifier) {\n    modifier.setNote(this);\n    modifier.setIndex(index);\n    this.modifiers.push(modifier);\n    this.setPreFormatted(false);\n    return this;\n  }\n\n  // Helper function to add an accidental to a key\n  addAccidental(index, accidental) {\n    return this.addModifier(index, accidental);\n  }\n\n  // Helper function to add an articulation to a key\n  addArticulation(index, articulation) {\n    return this.addModifier(index, articulation);\n  }\n\n  // Helper function to add an annotation to a key\n  addAnnotation(index, annotation) {\n    return this.addModifier(index, annotation);\n  }\n\n  // Helper function to add a dot on a specific key\n  addDot(index) {\n    const dot = new Dot();\n    dot.setDotShiftY(this.glyph.dot_shiftY);\n    this.dots++;\n    return this.addModifier(index, dot);\n  }\n\n  // Convenience method to add dot to all keys in note\n  addDotToAll() {\n    for (let i = 0; i < this.keys.length; ++i) {\n      this.addDot(i);\n    }\n    return this;\n  }\n\n  // Get all accidentals in the `ModifierContext`\n  getAccidentals() {\n    return this.modifierContext.getModifiers('accidentals');\n  }\n\n  // Get all dots in the `ModifierContext`\n  getDots() {\n    return this.modifierContext.getModifiers('dots');\n  }\n\n  // Get the width of the note if it is displaced. Used for `Voice`\n  // formatting\n  getVoiceShiftWidth() {\n    // TODO: may need to accomodate for dot here.\n    return this.getGlyphWidth() * (this.displaced ? 2 : 1);\n  }\n\n  // Calculates and sets the extra pixels to the left or right\n  // if the note is displaced.\n  calcNoteDisplacements() {\n    this.setLeftDisplacedHeadPx(\n      this.displaced && this.stem_direction === Stem.DOWN\n        ? this.getGlyphWidth()\n        : 0\n    );\n\n    // For upstems with flags, the extra space is unnecessary, since it's taken\n    // up by the flag.\n    this.setRightDisplacedHeadPx(\n      !this.hasFlag() && this.displaced && this.stem_direction === Stem.UP\n        ? this.getGlyphWidth()\n        : 0\n    );\n  }\n\n  // Pre-render formatting\n  preFormat() {\n    if (this.preFormatted) return;\n    if (this.modifierContext) this.modifierContext.preFormat();\n\n    let width = this.getGlyphWidth() + this.leftDisplacedHeadPx + this.rightDisplacedHeadPx;\n\n    // For upward flagged notes, the width of the flag needs to be added\n    if (this.glyph.flag && this.beam === null && this.stem_direction === Stem.UP) {\n      width += this.getGlyphWidth();\n      // TODO: Add flag width as a separate metric\n    }\n\n    this.setWidth(width);\n    this.setPreFormatted(true);\n  }\n\n  /**\n   * @typedef {Object} noteHeadBounds\n   * @property {number} y_top the highest notehead bound\n   * @property {number} y_bottom the lowest notehead bound\n   * @property {number|Null} displaced_x the starting x for displaced noteheads\n   * @property {number|Null} non_displaced_x the starting x for non-displaced noteheads\n   * @property {number} highest_line the highest notehead line in traditional music line\n   *  numbering (bottom line = 1, top line = 5)\n   * @property {number} lowest_line the lowest notehead line\n   * @property {number|false} highest_displaced_line the highest staff line number\n   *   for a displaced notehead\n   * @property {number|false} lowest_displaced_line\n   * @property {number} highest_non_displaced_line\n   * @property {number} lowest_non_displaced_line\n   */\n\n  /**\n   * Get the staff line and y value for the highest & lowest noteheads\n   * @returns {noteHeadBounds}\n   */\n  getNoteHeadBounds() {\n    // Top and bottom Y values for stem.\n    let yTop = null;\n    let yBottom = null;\n    let nonDisplacedX = null;\n    let displacedX = null;\n\n    let highestLine = this.stave.getNumLines();\n    let lowestLine = 1;\n    let highestDisplacedLine = false;\n    let lowestDisplacedLine = false;\n    let highestNonDisplacedLine = highestLine;\n    let lowestNonDisplacedLine = lowestLine;\n\n    this.note_heads.forEach(notehead => {\n      const line = notehead.getLine();\n      const y = notehead.getY();\n\n      if (yTop === null || y < yTop) {\n        yTop = y;\n      }\n\n      if (yBottom === null || y > yBottom) {\n        yBottom = y;\n      }\n\n      if (displacedX === null && notehead.isDisplaced()) {\n        displacedX = notehead.getAbsoluteX();\n      }\n\n      if (nonDisplacedX === null && !notehead.isDisplaced()) {\n        nonDisplacedX = notehead.getAbsoluteX();\n      }\n\n      highestLine = line > highestLine ? line : highestLine;\n      lowestLine = line < lowestLine ? line : lowestLine;\n\n      if (notehead.isDisplaced()) {\n        highestDisplacedLine = (highestDisplacedLine === false) ?\n          line : Math.max(line, highestDisplacedLine);\n        lowestDisplacedLine = (lowestDisplacedLine === false) ?\n          line : Math.min(line, lowestDisplacedLine);\n      } else {\n        highestNonDisplacedLine = Math.max(line, highestNonDisplacedLine);\n        lowestNonDisplacedLine = Math.min(line, lowestNonDisplacedLine);\n      }\n    }, this);\n\n    return {\n      y_top: yTop,\n      y_bottom: yBottom,\n      displaced_x: displacedX,\n      non_displaced_x: nonDisplacedX,\n      highest_line: highestLine,\n      lowest_line: lowestLine,\n      highest_displaced_line: highestDisplacedLine,\n      lowest_displaced_line: lowestDisplacedLine,\n      highest_non_displaced_line: highestNonDisplacedLine,\n      lowest_non_displaced_line: lowestNonDisplacedLine,\n    };\n  }\n\n  // Get the starting `x` coordinate for the noteheads\n  getNoteHeadBeginX() {\n    return this.getAbsoluteX() + this.x_shift;\n  }\n\n  // Get the ending `x` coordinate for the noteheads\n  getNoteHeadEndX() {\n    const xBegin = this.getNoteHeadBeginX();\n    return xBegin + this.getGlyphWidth();\n  }\n\n  // Draw the ledger lines between the stave and the highest/lowest keys\n  drawLedgerLines() {\n    const {\n      stave, glyph,\n      render_options: { stroke_px },\n      context: ctx,\n    } = this;\n\n    const width = glyph.getWidth() + (stroke_px * 2);\n    const doubleWidth = 2 * (glyph.getWidth() + stroke_px) - (Stem.WIDTH / 2);\n\n    if (this.isRest()) return;\n    if (!ctx) {\n      throw new Vex.RERR('NoCanvasContext', \"Can't draw without a canvas context.\");\n    }\n\n    const {\n      highest_line,\n      lowest_line,\n      highest_displaced_line,\n      highest_non_displaced_line,\n      lowest_displaced_line,\n      lowest_non_displaced_line,\n      displaced_x,\n      non_displaced_x,\n    } = this.getNoteHeadBounds();\n\n    const min_x = Math.min(displaced_x, non_displaced_x);\n\n    const drawLedgerLine = (y, normal, displaced) => {\n      let x;\n      if (displaced && normal) x = min_x - stroke_px;\n      else if (normal) x = non_displaced_x - stroke_px;\n      else x = displaced_x - stroke_px;\n      const ledgerWidth = (normal && displaced) ? doubleWidth : width;\n\n      ctx.beginPath();\n      ctx.moveTo(x, y);\n      ctx.lineTo(x + ledgerWidth, y);\n      ctx.stroke();\n    };\n\n    const style = { ...stave.getStyle() || {}, ...this.getLedgerLineStyle() || {} };\n    this.applyStyle(ctx, style);\n\n    // Draw ledger lines below the staff:\n    for (let line = 6; line <= highest_line; ++line) {\n      const normal = (non_displaced_x !== null) && (line <= highest_non_displaced_line);\n      const displaced = (displaced_x !== null) && (line <= highest_displaced_line);\n      drawLedgerLine(stave.getYForNote(line), normal, displaced);\n    }\n\n    // Draw ledger lines above the staff:\n    for (let line = 0; line >= lowest_line; --line) {\n      const normal = (non_displaced_x !== null) && (line >= lowest_non_displaced_line);\n      const displaced = (displaced_x !== null) && (line >= lowest_displaced_line);\n      drawLedgerLine(stave.getYForNote(line), normal, displaced);\n    }\n\n    this.restoreStyle(ctx, style);\n  }\n\n  // Draw all key modifiers\n  drawModifiers() {\n    if (!this.context) {\n      throw new Vex.RERR('NoCanvasContext', \"Can't draw without a canvas context.\");\n    }\n\n    const ctx = this.context;\n    ctx.openGroup('modifiers');\n    for (let i = 0; i < this.modifiers.length; i++) {\n      const modifier = this.modifiers[i];\n      const notehead = this.note_heads[modifier.getIndex()];\n      const noteheadStyle = notehead.getStyle();\n      notehead.applyStyle(ctx, noteheadStyle);\n      modifier.setContext(ctx);\n      modifier.drawWithStyle();\n      notehead.restoreStyle(ctx, noteheadStyle);\n    }\n    ctx.closeGroup();\n  }\n\n  // Draw the flag for the note\n  drawFlag() {\n    const { stem, beam, context: ctx } = this;\n\n    if (!ctx) {\n      throw new Vex.RERR('NoCanvasContext', \"Can't draw without a canvas context.\");\n    }\n\n    const shouldRenderFlag = beam === null;\n    const glyph = this.getGlyph();\n\n    if (glyph.flag && shouldRenderFlag) {\n      const { y_top, y_bottom } = this.getNoteHeadBounds();\n      const noteStemHeight = stem.getHeight();\n      const flagX = this.getStemX();\n      // FIXME: What's with the magic +/- 2\n      const flagY = this.getStemDirection() === Stem.DOWN\n        // Down stems have flags on the left\n        ? y_top - noteStemHeight + 2\n        // Up stems have flags on the eft.\n        : y_bottom - noteStemHeight - 2;\n\n      // Draw the Flag\n      ctx.openGroup('flag', null, { pointerBBox: true });\n      this.applyStyle(ctx, this.getFlagStyle() || false);\n      this.flag.render(ctx, flagX, flagY);\n      this.restoreStyle(ctx, this.getFlagStyle() || false);\n      ctx.closeGroup();\n    }\n  }\n\n  // Draw the NoteHeads\n  drawNoteHeads() {\n    this.note_heads.forEach(notehead => {\n      this.context.openGroup('notehead', null, { pointerBBox: true });\n      notehead.setContext(this.context).draw();\n      this.context.closeGroup();\n    });\n  }\n\n  drawStem(stemStruct) {\n    // GCR TODO: I can't find any context in which this is called with the stemStruct\n    // argument in the codebase or tests. Nor can I find a case where super.drawStem\n    // is called at all. Perhaps these should be removed?\n    if (!this.context) {\n      throw new Vex.RERR('NoCanvasContext', \"Can't draw without a canvas context.\");\n    }\n\n    if (stemStruct) {\n      this.setStem(new Stem(stemStruct));\n    }\n\n    this.context.openGroup('stem', null, { pointerBBox: true });\n    this.stem.setContext(this.context).draw();\n    this.context.closeGroup();\n  }\n\n  // Draws all the `StaveNote` parts. This is the main drawing method.\n  draw() {\n    if (!this.context) {\n      throw new Vex.RERR('NoCanvasContext', \"Can't draw without a canvas context.\");\n    }\n    if (!this.stave) {\n      throw new Vex.RERR('NoStave', \"Can't draw without a stave.\");\n    }\n    if (this.ys.length === 0) {\n      throw new Vex.RERR('NoYValues', \"Can't draw note without Y values.\");\n    }\n\n    const xBegin = this.getNoteHeadBeginX();\n    const shouldRenderStem = this.hasStem() && !this.beam;\n\n    // Format note head x positions\n    this.note_heads.forEach(notehead => notehead.setX(xBegin));\n\n    // Format stem x positions\n    const stemX = this.getStemX();\n    this.stem.setNoteHeadXBounds(stemX, stemX);\n\n    L('Rendering ', this.isChord() ? 'chord :' : 'note :', this.keys);\n\n    // Draw each part of the note\n    this.drawLedgerLines();\n\n    // Apply the overall style -- may be contradicted by local settings:\n    this.applyStyle();\n    this.setAttribute('el', this.context.openGroup('stavenote', this.getAttribute('id')));\n    this.context.openGroup('note', null, { pointerBBox: true });\n    if (shouldRenderStem) this.drawStem();\n    this.drawNoteHeads();\n    this.drawFlag();\n    this.context.closeGroup();\n    this.drawModifiers();\n    this.context.closeGroup();\n    this.restoreStyle();\n    this.setRendered();\n  }\n}\n"],"file":"stavenote.js"}